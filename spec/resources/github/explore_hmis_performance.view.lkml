include: "../client_program_screening_base.view.lkml"
include: "../screen_entry.view.lkml"
include: "../screen_update.view.lkml"
include: "../screen_last.view.lkml"
include: "../screen_followup.view.lkml"
include: "../client_assessment_demographics.view.lkml"
include: "../clients_log.view.lkml"
include: "../household_screens.view.lkml"
include: "../household_entry_screen.view.lkml"
include: "../household.view.lkml"
include: "../client_service_expenses.view.lkml"
include: "../client_service_dates.view.lkml"
include: "../client_service_time_tracking.view.lkml"
include: "../client_custom.view.lkml"
include: "../client_demographics.view.lkml"
include: "../client_move_in_date.view.lkml"
include: "../client_move_in_date.view.lkml"
include: "../entry_custom.view.lkml"
include: "../client_files.view.lkml"
include: "../files.view.lkml"
include: "../client_file_names.view.lkml"
include: "../client_file_categories.view.lkml"
include: "../household_exit_screen.view.lkml"
include: "../last_custom.view.lkml"
include: "../followup_custom.view.lkml"
include: "../status_update_custom.view.lkml"
include: "../inbound_recidivism.view.lkml"
include: "../outbound_recidivism.view.lkml"
include: "../client_program_staff.view.lkml"
include: "../client_programs.view.lkml"
include: "../assessing_program.view.lkml"
include: "../client_last_enrollment_by_type.view.lkml"
include: "../client_first_enrollment_by_type.view.lkml"
include: "../client_last_program.view.lkml"
include: "../client_last_system_program_enrollment.view.lkml"
include: "../client_first_program.view.lkml"
include: "../client_first_system_enrollment.view.lkml"
include: "../members.view.lkml"
include: "../programs.view.lkml"
include: "../program_coc.view.lkml"
include: "../program_sites.view.lkml"
include: "../sites.view.lkml"
include: "../program_funding_sources.view.lkml"
include: "../program_templates.view.lkml"
include: "../program_inventory.view.lkml"
include: "../agencies.view.lkml"
include: "../counties.view.lkml"
include: "../client_profile_household.view.lkml"
include: "../household_move_in_date.view.lkml"
include: "../clients.view.lkml"
include: "../client_group_members.view.lkml"
include: "../client_groups.view.lkml"
include: "../client_addresses_recent.view.lkml"
include: "../client_addresses.view.lkml"
include: "../client_field_interactions.view.lkml"
include: "../client_notes.view.lkml"
include: "../chronic_homeless.view.lkml"
include: "../client_service_programs.view.lkml"
include: "../client_services.view.lkml"
include: "../service_items.view.lkml"
include: "../client_service_notes.view.lkml"
include: "../client_program_goals.view.lkml"
include: "../goals.view.lkml"
include: "../funding.view.lkml"
include: "../services.view.lkml"
include: "../client_last_system_service.view.lkml"
include: "../client_last_service.view.lkml"
include: "../client_last_service_by_enrollment.view.lkml"
include: "../client_service_accounts.view.lkml"
include: "../vendors.view.lkml"
include: "../client_last_assessment.view.lkml"
include: "../client_last_assessment_of_kind.view.lkml"
include: "../client_assessment_scores.view.lkml"
include: "../assessment_subtotals.view.lkml"
include: "../client_last_assessment_by_processor.view.lkml"
include: "../assessment_processors.view.lkml"
include: "../client_assessment_high_score.view.lkml"
include: "../client_last_assessment_id.view.lkml"
include: "../custom_score_ranges.view.lkml"
include: "../screens.view.lkml"
include: "../client_assessment_custom.view.lkml"
include: "../release_of_information.view.lkml"
include: "../hoh_client_location.view.lkml"
include: "../spm/sys_pm_1a1.view.lkml"
include: "../spm/sys_pm_1a2.view.lkml"
include: "../spm/sys_pm_1b1.view.lkml"
include: "../spm/sys_pm_1b2.view.lkml"
include: "../spm/sys_pm_2.view.lkml"
include: "../spm/sys_pm_3.view.lkml"
include: "../spm/sys_pm_4.view.lkml"
include: "../spm/sys_pm_5.view.lkml"
include: "../spm/sys_pm_7.view.lkml"
include: "../determinable_households.view.lkml"
include: "../client_contacts.view.lkml"
include: "../release_of_information_latest.view.lkml"
include: "../latest_enrollment_contextual.view.lkml"
include: "../latest_assessment_contextual.view.lkml"
include: "../roi_settings.view.lkml"
include: "../client_program_demographics.view.lkml"
include: "../client_programs_files.view.lkml"
include: "../enrollment_aggregates.view.lkml"
include: "../coordinated_entry_event.view.lkml"
include: "../geography_types.view.lkml"
include: "../current_living_situation.view.lkml"
include: "../client_service_employment.view.lkml"
include: "../employers.view.lkml"
include: "../service_item_account_configuration.view.lkml"
include: "../aggregations/last_assessment_filters.view.lkml"
include: "../first_enrollment_since_stably_housed.view.lkml"
include: "../aggregations/first_assessment_filters.view.lkml"
include: "../aggregations/last_assessment_filters.view.lkml"
include: "../aggregations/first_current_living_situation_filters.view.lkml"
include: "../aggregations/last_current_living_situation_filters.view.lkml"
include: "../geolocation/client_field_interactions_geolocations.view.lkml"
include: "../geolocation/client_addresses_geolocations.view.lkml"
include: "../geolocation/sites_geolocations.view.lkml"
include: "../geolocation/client_geolocations.view.lkml"
include: "../geolocation/client_services_geolocations.view.lkml"
include: "../geolocation/service_items_geolocations.view.lkml"
include: "../geolocation/agencies_geolocations.view.lkml"
include: "../geolocation/client_assessment_demographics_geolocations.view.lkml"
include: "../geolocation/client_program_demographics_geolocations.view.lkml"
include: "../program_custom.view.lkml"
# include: "../encampments/encampment_clients.view.lkml"
# include: "../encampments/encampments.view.lkml"
# include: "../encampments/encampments_normalized.view.lkml"
include: "../aggregations/client_contacts_rank.view.lkml"


explore: base {

  from: client_program_screening_base
  persist_for: "60 minutes"
  label: "HMIS Performance"
  fields: [
            ALL_FIELDS*,
            -clients.deleted,
            -client_assessments.deleted,
            -client_addresses.deleted,
            -client_addresses_recent.deleted,
            -enrollments.deleted,
            -client_notes.deleted,
            -release_of_information.deleted,
            -client_services.deleted,
            -program_inventory.deleted,
            -client_files.deleted,
            -release_of_information.deleted,
            -client_services.deleted,
            -program_inventory.deleted,
            -client_files.deleted,
            -client_contacts.deleted,
            -client_group_members.end_date,
            -enrollments.ref_agency,
            -enrollments.ref_agency_text,
            -enrollments.ref_agency_coc
          ]

  always_filter: {
    filters: {
      field: enrollments.date_filter
      value: "1 Quarter"
    }

  }

  access_filter:{field: agencies.id
    user_attribute: agency_id }
  access_filter:{field: agencies.coc
    user_attribute: agency_coc }
  access_filter:{field: agencies.county
    user_attribute: agency_county}

  always_join: [clients]
  sql_always_where:
        {% if _user_attributes['agency_id'] != '>0' %}
            (CASE WHEN ${clients.private} = 1 THEN ${clients.ref_agency} in ({{_user_attributes['agency_id']}})
            AND ( ${clients.deleted} is null OR ${clients.deleted} =0 )
            ELSE (${clients.private} = 0 or ${clients.private} is null) and ( ${clients.deleted} is NULL OR ${clients.deleted} =0 )END)
        {% else %}
            ( ${clients.deleted} is NULL OR ${clients.deleted} =0 )
        {% endif %}
  ;;

  join: entry_screen {
    fields: [entry_screen_set*]
    sql_on: ${base.first_entry_screen_id} = ${entry_screen.id} ;;
    relationship: many_to_one
    type: inner
  }

  join: clients_log {
    fields: []
    relationship: one_to_many
    sql_on: ${clients.id} = ${clients_log.ref_client} ;;
  }

  join: household_entry_screen {
    from: household_screens
    view_label: "Entry Screen"
    relationship: many_to_one
    type: left_outer
    sql_on: ${enrollments.ref_household} =  ${household_entry_screen.household_id} and ${household_entry_screen.screen_type} = 2 ;;
  }

  join: client_move_in_date {
    view_label: "Clients"
    relationship: many_to_one
    fields: [latest_move_in_client]
    type: left_outer
    sql_on: ${enrollments.id} = ${client_move_in_date.enrollment_id};;
  }

  join: client_move_in_date_client {
    from: client_move_in_date
    fields: [client_move_in_date_client.latest_move_in_client]
    view_label: "Enrollments"
    type: left_outer
    relationship: many_to_one
    sql_on: ${clients.id} = ${client_move_in_date_client.ref_client} ;;
  }

  join: entry_custom {
    type: inner
    relationship: one_to_one
    fields: [entry_custom_fields*]
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                ${entry_custom.ref_client_program_demographics} = ${entry_screen.id}
            {% else %}
                ${entry_custom.ref_client_program_demographics} = ${entry_screen.id} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
            {% endif %}
    ;;
  }

  join: last_screen {
    view_label: "Update/Exit Screen"
    fields: [last_screen_set*]
    type: left_outer
    relationship: many_to_one
    sql_on: ${base.last_screening_to_analyze} = ${last_screen.id} ;;
  }

  join: client_files {
    view_label: "Clients"
    type: left_outer
    relationship: many_to_one
    sql_where:
        {% if _user_attributes['agency_id'] != '>0' %}
              (CASE WHEN ${client_files.private} = 1 THEN ${client_files.ref_agency} in ({{_user_attributes['agency_id']}})
              AND ( ${client_files.deleted} is null OR ${client_files.deleted} =0 )
              ELSE (${client_files.private} = 0 or ${client_files.private} is NULL) AND ( ${client_files.deleted} is NULL OR ${client_files.deleted} =0 )END)
        {% else %}
              ( ${client_files.deleted} is NULL OR ${client_files.deleted} =0 )
        {% endif %};;

    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                ${client_files.ref_client} = ${clients.id} and (${client_files.deleted} = 0 or ${client_files.deleted} is null)
            {% else %}
                ${client_files.ref_client} = ${clients.id} and (${client_files.deleted} = 0 or ${client_files.deleted} is null) AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
            {% endif %}
    ;;
  }

  join: client_programs_files {
    fields: []
    type: left_outer
    relationship: many_to_one
    sql_on: ${client_files.id} = ${client_programs_files.ref_client_file}
      and ${enrollments.id} = ${client_programs_files.ref_client_program} ;;
  }

  join: files {
    fields: []
    relationship: many_to_one
    sql_on: ${client_files.ref_file} = ${files.id} ;;
  }

  join: client_file_names {
    fields: []
    type: left_outer
    relationship: many_to_one
    sql_on: ${client_files.ref_file_name} = ${client_file_names.id} ;;
  }

  join: client_file_categories {
    view_label: "Clients"
    fields: []
    type: left_outer
    relationship: many_to_one
    sql_on: ${client_files.ref_category} = ${client_file_categories.id} ;;
  }

  join: household_exit_screen {
    from: household_screens
    view_label: "Update/Exit Screen"
    relationship: many_to_one
    type: left_outer
    sql_on: ${enrollments.ref_household} =  ${household_exit_screen.household_id}
      AND ${household_exit_screen.screen_type} = ${last_screen.screen_type} ;;
  }

  join: last_exit_screen {
    from: last_screen
    fields: []
    sql_on: ${base.last_exit_screen_id} = ${last_exit_screen.id}  ;;
    type: left_outer
    relationship: many_to_one
  }

  join: last_custom {
    type: left_outer
    relationship: many_to_one
    view_label: "Update/Exit Custom"
    fields: [last_custom_fields*]
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
            ${last_custom.ref_client_program_demographics} = ${last_screen.id}
        {% else %}
            ${last_custom.ref_client_program_demographics} = ${last_screen.id} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
        {% endif %} ;;
  }

  join: followup_custom {
    type: left_outer
    relationship: many_to_one
    view_label: "Followup Custom"
    fields: [followup_custom_fields*]
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
            ${followup_custom.ref_client_program_demographics} = ${followup_screen.id}
        {% else %}
            ${followup_custom.ref_client_program_demographics} = ${followup_screen.id} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
        {% endif %} ;;
  }


  join: followup_screen {
    fields: [followup_screen_set*]
    view_label: "Followup Screen"
    type: left_outer
    relationship: many_to_one
    sql_on: ${followup_screen.ref_program} = ${enrollments.id} and ${followup_screen.screen_type} = 5
      and (${followup_screen.deleted} is null or ${followup_screen.deleted} = 0);;
  }

  join: status_update_screen {
    fields: [update_screen_set*]
    view_label: "Status Update Screen"
    type: left_outer
    relationship: many_to_one
    sql_on: ${status_update_screen.ref_client} = ${clients.id} AND
          ${status_update_screen.ref_program} = ${enrollments.id} and ${status_update_screen.screen_type} in (3,6)
      and (${status_update_screen.deleted} is null or ${status_update_screen.deleted} = 0);;
  }

  join: status_update_custom {
    view_label: "Status Update Custom"
    type: left_outer
    relationship: many_to_one
    fields: [status_update_custom_fields*]
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
            ${status_update_custom.ref_client_program_demographics} = ${status_update_screen.id}
        {% else %}
            ${status_update_custom.ref_client_program_demographics} = ${status_update_screen.id} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
        {% endif %} ;;
  }

  join: current_living_situation {
    type: left_outer
    relationship: one_to_one
    sql_on:
        ${current_living_situation.id} = ${status_update_screen.id}
          AND ${current_living_situation.screen_type} = 3
          AND ${current_living_situation.status_screen_type} = 2
          AND (${current_living_situation.deleted} IS NULL OR ${current_living_situation.deleted} = 0)
    ;;
  }

#   join: base_first_current_living_situation {
#     type: left_outer
#     relationship: one_to_one
#     sql_on: ${base_first_current_living_situation.min_cls_id} = ${current_living_situation.id};;
#   }
#
#
#   join: base_last_current_living_situation {
#     type: left_outer
#     relationship: one_to_one
#     sql_on: ${base_last_current_living_situation.max_cls_id} = ${current_living_situation.id};;
#   }


  join: inbound_recidivism {
    type: left_outer
    relationship: many_to_one
    sql_on: ${entry_screen.id} = ${inbound_recidivism.screen_id} AND ${entry_screen.deleted} IS NULL ;;
  }

  join: outbound_recidivism {
    type: left_outer
    relationship: many_to_one
    sql_on: ${outbound_recidivism.screen_id} =${last_screen.id} AND ${last_screen.deleted} IS NULL ;;
  }

  join: client_program_staff {
    fields: []
    relationship: many_to_one
    sql_on: ${client_program_staff.ref_client_program} = ${enrollments.id} ;;
  }

  join: enrollments {
    type: inner
    relationship: one_to_one
    required_joins: [client_program_staff]
    sql_on:       ${base.ref_program} = ${enrollments.id}
            AND ( ${enrollments.deleted} is null OR ${enrollments.deleted} =0 )
    ;;
  }

  join: first_enrollment_since_stably_housed {
    fields: []
    relationship: many_to_one
    sql_on: ${clients.id} = ${first_enrollment_since_stably_housed.personal_id}
              AND ${enrollments.id} = ${first_enrollment_since_stably_housed.enrollment_id};;
  }


  join: coordinated_entry_event {
    relationship: many_to_one
    sql_on: ${coordinated_entry_event.ref_client} = ${clients.id}
              AND ${coordinated_entry_event.enrollment_id} = ${enrollments.id}


;;
  }


  join: assessing_program {
    relationship: many_to_one
    sql_on: ${assessing_program.ref_client_assessment} = ${client_assessments.id}
            ;;
  }

  join: client_last_enrollment_by_type {
    fields: []
    relationship: many_to_one
    sql_on: ${base.ref_client} = ${client_last_enrollment_by_type.ref_client}
      and ${programs.ref_category} = ${client_last_enrollment_by_type.ref_category} ;;
  }

  join: client_first_enrollment_by_type {
    fields: []
    relationship: many_to_one
    sql_on: ${base.ref_client} = ${client_first_enrollment_by_type.ref_client}
      and ${programs.ref_category} = ${client_first_enrollment_by_type.ref_category} ;;
  }

  join: client_last_program {
    fields: []
    relationship: many_to_one
    sql_on: ${client_last_program.id} = ${enrollments.id} ;;
  }

  join: client_last_system_program_enrollment {
    fields: []
    relationship: many_to_one
    sql_on: ${client_last_system_program_enrollment.id} = ${enrollments.id} ;;
  }

  join: client_first_program {
    fields: []
    relationship: many_to_one
    sql_on: ${client_first_program.id} = ${enrollments.id} ;;
  }

  join: client_first_system_enrollment {
    fields: []
    relationship: many_to_one
    sql_on: ${client_first_system_enrollment.id} = ${enrollments.id} ;;
  }

  join: members {
    fields: []
    relationship: many_to_one
    sql_on: ${client_program_staff.ref_user} = ${members.ref_user} ;;
  }

  join: programs {
    fields: [
      availability_start_date,
      availability_end_date,
      ref_agency,
      name,
      project_type_code,
      agency_project_name,
      id,
      list_of_program_names,
      added_date,
      description,
      tracking_method,
      program_applicability,
      status,
      ref_target_b,
      count,
      coc_information*
    ]
    relationship: many_to_one
    sql_on: ${enrollments.ref_program} = ${programs.id} ;;
  }

  join: program_custom {
    relationship: one_to_many
    sql_on: ${programs.id} = ${program_custom.ref_program} ;;
  }

  join: program_coc {
    relationship: one_to_many
    fields: []
    sql_on: ${programs.id} = ${program_coc.ref_program} and (${program_coc.deleted} is null or ${program_coc.deleted} = 0) ;;
  }

  join: program_sites {
    fields: [is_primary]
    relationship: many_to_one
    sql_on: ${programs.id} = ${program_sites.ref_program} ;;
  }

  join: sites {
    fields: [coc]
    relationship: many_to_one
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                ${sites.id} = ${program_sites.ref_site}
            {% else %}
                ${sites.id} = ${program_sites.ref_site} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
            {% endif %}
    ;;
  }

  join: geography_types {
    fields: [geography_types.geography_type]
    type: left_outer
    relationship: many_to_one
    sql_on: ${sites.ref_geography_type} = ${geography_types.id};;
  }

  join: program_funding_sources {
    relationship: many_to_one
    sql_on: ${programs.id} = ${program_funding_sources.ref_program} ;;
  }

  join: program_templates {
    fields: []
    relationship: many_to_one
    sql_on: ${programs.ref_template} = ${program_templates.id} ;;
  }

  join: program_inventory {
    relationship: one_to_many
    sql_on: ${programs.id} = ${program_inventory.ref_program} and  ( program_inventory.deleted is null OR  program_inventory.deleted =0 ) ;;
  }

  join: agencies {
    fields: [id, coc, name, status, county, victim_service_provider]
    relationship: many_to_one
    sql_on: ${programs.ref_agency} = ${agencies.id} ;;
  }

  join: counties {
    fields: []
    relationship: many_to_one
    sql_on: ${counties.id} = ${agencies.ref_county} ;;
  }

  join: household_makeup {
    view_label: "Enrollments"
    relationship: many_to_one
    sql_on: ${enrollments.ref_household} = ${household_makeup.id} ;;
  }

  join: client_profile_household {
    view_label: "Clients"
    type:  left_outer
    relationship: many_to_one
    sql_on: ${clients.id} = ${client_profile_household.personal_id}
      ;;
  }

  join: household_move_in_date {
    relationship: one_to_one
    sql_on: ${enrollments.id} = ${household_move_in_date.enrollment_id} ;;
  }

  join: clients {
    type: inner
    relationship: one_to_one
    sql_on: ${base.ref_client} = ${clients.id} ;;
  }


  join: client_group_members {
    view_label: "Clients"
    relationship: many_to_one
    sql_on: ${clients.id} = ${client_group_members.ref_client} and ${client_group_members.end_date} IS NULL

          ;;
  }


  join: client_groups {
    fields: []
    relationship: many_to_one
    sql_on: ${client_groups.ref_client} = ${client_group_members.ref_client} ;;
  }

  join: client_addresses_recent {
    fields: []
    type: left_outer
    relationship: many_to_one
    sql_on: ${base.ref_client} = ${client_addresses_recent.ref_client} ;;
  }

  join: client_addresses {
    relationship: many_to_one
    sql_where:
            {% if _user_attributes['agency_id'] != '>0' %}
                  (CASE WHEN ${client_addresses.private} = 1 THEN ${client_addresses.ref_agency} in ({{_user_attributes['agency_id']}})
                  AND ( ${client_addresses.deleted} is NULL OR ${client_addresses.deleted} =0 )
                  ELSE (${client_addresses.private} = 0 or ${client_addresses.private} is NULL) AND ( ${client_addresses.deleted} is NULL OR ${client_addresses.deleted} =0 )END)
            {% else %}
                  ( ${client_addresses.deleted} is NULL OR ${client_addresses.deleted} =0 )
            {% endif %}
    ;;

      sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                      ${base.ref_client} = ${client_addresses.ref_client}  and ${client_addresses.deleted} is null
                  {% else %}
                      ${base.ref_client} = ${client_addresses.ref_client}  and ${client_addresses.deleted} is null AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
                  {% endif %}
    ;;
  }

  join: client_field_interactions {
    view_label: "Client Field Interactions"
    relationship: many_to_one
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                    ${base.ref_client} = ${client_field_interactions.ref_client}
                {% else %}
                    ${base.ref_client} = ${client_field_interactions.ref_client} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
                {% endif %} ;;
  }

  join: client_notes {
    relationship: many_to_one
    sql_where:
          {% if _user_attributes['agency_id'] != '>0' %}
                (CASE WHEN (${client_notes.private} = 1 OR ${client_notes.ref_client_program_id} IS NOT NULL)
                      THEN ${client_notes.ref_agency} in ({{_user_attributes['agency_id']}})
                  AND (${client_notes.deleted} is NULL OR ${client_notes.deleted} =0)
                  ELSE (${client_notes.private} = 0 or ${client_notes.private} is NULL)
                    AND (${client_notes.deleted} is NULL OR ${client_notes.deleted} =0)
                 END)
          {% else %}
                ( ${client_notes.deleted} is NULL OR ${client_notes.deleted} =0 )
          {% endif %};;

      sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                      ${clients.id} = ${client_notes.ref_client}
                  {% else %}
                      ${clients.id} = ${client_notes.ref_client} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
                  {% endif %}
    ;;
  }

  join: chronic_homeless {
    fields: []
    relationship: many_to_one
    sql_on: ${chronic_homeless.ref_client} = ${clients.id}
              AND ${enrollments.id} = ${chronic_homeless.enrollment_id}
              AND ${chronic_homeless.screen_type} = 2;;
  }

  join: chronic_homeless_beta {
    relationship: many_to_one
    sql_on: ${chronic_homeless_beta.enrollment_id} = ${enrollments.id} ;;
  }

  join: static_demographics {
    from: client_demographics
    view_label: "Clients"
    type: inner
    relationship: one_to_one
    fields: [
      id,
      gender,
      gender_text,
      ethnicity,
      ethnicity_text,
      name_middle,
      name_suffix,
      ref_client,
      race,
      race_text,
      race_1_text,
      race_2_text,
      race_3_text,
      race_4_text,
      race_5_text,
      marital_status,
      veteran,
      veteran_text,
      veteran_branch,
      veteran_discharge,
      veteran_theater_afg,
      veteran_theater_iraq1,
      veteran_theater_iraq2,
      veteran_theater_kw,
      veteran_theater_other,
      veteran_theater_pg,
      veteran_theater_vw,
      veteran_theater_ww2,
      veteran_entered,
      veteran_separated,
      zipcode,
      primary_language
    ]
    sql_on: ${clients.id} = ${static_demographics.ref_client} ;;
  }

  join: static_demographics_custom {
    from: client_custom
    fields: [client_custom_fields*]
    relationship: many_to_one
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                      ${static_demographics.id} = ${static_demographics_custom.ref_client_demographics}
                    {% else %}
                      ${static_demographics.id} = ${static_demographics_custom.ref_client_demographics} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
                    {% endif %}
    ;;
  }

  join: client_service_programs {
    fields: []
    type: left_outer
    relationship: many_to_one
    sql_on: ${enrollments.id} = ${client_service_programs.ref_client_program} ;;
  }

  join: client_services {
    fields: []
    type: left_outer
    relationship: many_to_one
    sql_on: ${client_services.id} = ${client_service_programs.ref_client_service}
              AND ( ${client_services.deleted} IS NULL OR ${client_services.deleted} = 0 )
              AND CASE WHEN {% date_start services.date_filter %} IS NOT NULL
                        THEN  ${client_services.start_date} <= {% date_end services.date_filter %}
                         AND (${client_services.end_date} >= {% date_start services.date_filter %}
                           OR ${client_services.end_date} IS NULL)
                        ELSE TRUE
                      END
    ;;
  }

  join: service_items {
    fields: []
    relationship: one_to_one
    sql_on: ${service_items.id} = ${client_services.ref_service_item} ;;
  }

  join: client_service_notes {
    fields: []
    relationship: many_to_one
    sql_on: ${client_service_notes.ref_client_service} = ${client_services.id} ;;
  }

  join: client_program_goals {
    view_label: "Goals"
    relationship: many_to_one
    sql_on: ${client_program_goals.ref_client_program} = ${enrollments.id} ;;
  }

  join: goals {
    fields: []
    relationship: many_to_one
    sql_on: ${goals.id} = ${client_program_goals.ref_goal} ;;
  }

  join: service_expenses {
    relationship: one_to_one
    sql_on: ${service_expenses.ref_client_service} = ${client_services.id} ;;
  }

  join: client_contacts{
    relationship: many_to_one
    sql_where:
          {% if _user_attributes['agency_id'] != '>0' %}
                (CASE WHEN ${client_contacts.private} = 1 THEN ${client_contacts.ref_agency} in ({{_user_attributes['agency_id']}})
                AND ( ${client_contacts.deleted} is NULL OR ${client_contacts.deleted} =0 )
                ELSE (${client_contacts.private} = 0 or ${client_contacts.private} is NULL) AND ( ${client_contacts.deleted} is NULL OR ${client_contacts.deleted} =0 )END)
          {% else %}
                ( ${client_contacts.deleted} is NULL OR ${client_contacts.deleted} =0 )
          {% endif %};;
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                ${base.ref_client} = ${client_contacts.ref_client}  and ${client_contacts.deleted} is null
            {% else %}
                ${base.ref_client} = ${client_contacts.ref_client}  and ${client_contacts.deleted} is null AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
            {% endif %} ;;
  }

  join: base_rank_client_contacts {
    view_label: "Client Contacts"
    type: left_outer
    relationship: one_to_one
    sql_on: ${client_contacts.id} = ${base_rank_client_contacts.id} ;;
  }

  join: funding {
    view_label: "Service Funding"
    relationship: many_to_one
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                      ${funding.id} = ${service_expenses.ref_funding}
                  {% else %}
                      ${funding.id} = ${service_expenses.ref_funding} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
                  {% endif %}
    ;;
  }

  join: service_time_tracking {
    relationship: one_to_one
    sql_on: ${service_time_tracking.ref_client_service} = ${client_services.id} ;;
  }

  join: services {
    relationship: many_to_one
    sql_on: ${service_items.ref_service} = ${services.id} ;;
  }

  join: client_last_system_service {
    fields: []
    relationship: one_to_one
    sql_on: ${client_services.id} = ${client_last_system_service.id} ;;
  }

  join: client_last_service {
    fields: []
    relationship: many_to_one
    sql_on: ${client_services.id} = ${client_last_service.id}
      ;;
  }

  join: client_last_service_by_enrollment {
    fields: []
    relationship: many_to_one
    sql_on: ${client_services.id} = ${client_last_service_by_enrollment.id} ;;
  }

  join: client_service_accounts{
    fields: []
    relationship: many_to_one
    sql_on: ${client_service_accounts.ref_client_service} = ${client_services.id}  ;;
  }

  join: vendors{
    relationship: many_to_one
    view_label: "Service Account Option"
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                      ${client_service_accounts.ref_account} = ${vendors.id}
                  {% else %}
                      ${client_service_accounts.ref_account} = ${vendors.id} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
                  {% endif %} ;;
  }

  join: service_dates {
    type: left_outer
    relationship: one_to_many
    sql_on: ${service_dates.ref_client_service} = ${client_services.id}
                      AND ${service_items.ref_delivery_type} IN (2, 3)
                      AND CASE WHEN {% date_start services.date_filter %} IS NOT NULL
                            THEN ${service_dates.date_date} BETWEEN {% date_start services.date_filter %}
                                                                AND {% date_end services.date_filter %}
                            ELSE TRUE
                       END
            ;;
  }

  join: client_assessments {
    relationship: many_to_one
    sql_on: ${clients.id} = ${client_assessments.ref_client} and  ( ${client_assessments.deleted} is null OR ${client_assessments.deleted} =0 )
            AND
              {% if _user_attributes['agency_id'] != '>0' %}
                (CASE WHEN ${client_assessments.private} = 1
                    THEN ${client_assessments.ref_agency} in ({{_user_attributes['agency_id']}})
                    AND ( ${client_assessments.deleted} is NULL OR ${client_assessments.deleted} =0 )
                ELSE (${client_assessments.private} = 0 or ${client_assessments.private} is NULL)
                    AND ( ${client_assessments.deleted} is NULL OR ${client_assessments.deleted} =0 )
                    AND ${client_assessments.ref_agency} in ({{_user_attributes['agency_id']}})
                END)
              {% else %}
                TRUE
              {% endif %}
    ;;
  }

  join: latest_assessment_contextual {
    fields: []
    relationship: one_to_one
    type: left_outer
    sql_on: ${clients.id} = ${latest_assessment_contextual.ref_client} ;;
  }

  join: client_last_assessment {
    fields: []
    relationship: many_to_one
    sql_on: ${client_assessments.id} = ${client_last_assessment.id} ;;
  }

  join: client_last_assessment_of_kind {
    fields: []
    relationship: many_to_one
    sql_on: ${client_assessments.id} = ${client_last_assessment_of_kind.id} ;;
  }

  join: client_assessment_scores {
    fields: [assessment_score_average, assessment_score_max]
    relationship: many_to_one
    sql_on: ${client_assessments.id} = ${client_assessment_scores.ref_assessment} ;;
  }

  join: assessment_subtotals {
    fields: [code]
    relationship: many_to_one
    sql_on: ${assessment_subtotals.ref_assessment_processor} = ${assessment_processors.id} ;;
  }

  join: client_last_assessment_by_processor {
    fields: []
    relationship: many_to_one
    sql_on: ${client_assessments.id} = ${client_last_assessment_by_processor.id} ;;
  }

  join: assessment_processors {
    fields: []
    relationship: many_to_one
    sql_on: ${assessment_processors.code} = ${client_assessment_scores.score_type} ;;
  }

  join: client_assessment_high_score {
    fields: []
    relationship: many_to_one
    sql_on: ${client_assessment_high_score.ref_assessment} = ${client_assessments.id} ;;
  }

  join: client_last_assessment_id {
    fields: []
    relationship: many_to_one
    sql_on: ${client_assessments.id} = ${client_last_assessment_id.id} ;;
  }

  join: custom_score_ranges {
    fields: []
    relationship: many_to_one
    sql_on: ${custom_score_ranges.id} = ${client_assessments.id} ;;
  }

  join: screens {
    fields: []
    type: left_outer
    relationship: many_to_one
    sql_on: ${screens.id} = ${client_assessments.ref_assessment} ;;
  }

  join: client_assessment_custom {
    type: left_outer
    relationship: many_to_one
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                      ${client_assessments.id} =${client_assessment_custom.ref_client_assessment_demographics}
                  {% else %}
                      ${client_assessments.id} =${client_assessment_custom.ref_client_assessment_demographics} AND ${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
                  {% endif %} ;;
  }

  join: release_of_information {
    relationship: many_to_one
    sql_on: {% if _user_attributes['allow_sensitive_data'] == 'yes' %}
                      ${release_of_information.ref_client} =${clients.id}  and ( ${release_of_information.deleted} is null OR ${release_of_information.deleted} =0 )
                  {% else %}
                      ${release_of_information.ref_client} =${clients.id}  and ( ${release_of_information.deleted} is null OR ${release_of_information.deleted} =0 )
                      AND (${agencies.id} in ({{ _user_attributes['agency_root_id'] }})
                     -- OR (${roi_settings.default_model} = 2 and ${agencies.coc} = {{ _user_attributes['agency_coc']}})
                        )
                  {% endif %} ;;
  }

  join: release_of_information_latest {
    relationship: one_to_one
    sql_on: ${clients.id} = ${release_of_information_latest.personal_id} ;;
  }

  join: roi_agencies {
    from: agencies
    fields: []
    relationship: many_to_one
    sql_on: ${release_of_information.ref_agency} =${roi_agencies.id} ;;
  }

  join: roi_settings {
    fields: []
    relationship: many_to_one
    type: left_outer
    sql_on: ${agencies.id} = ${roi_settings.ref_agency} ;;
  }

  join: latest_enrollment_contextual {
    fields: [latest_enrollment_contextual.is_latest_enrollment_contextual]
    relationship: one_to_one
    type: left_outer
    sql_on: ${enrollments.id} = ${latest_enrollment_contextual.latest_enrollment_id} ;;
  }

  join: client_latest_enrollment_per_agency {
    relationship: one_to_one
    type: left_outer
    sql_on: ${enrollments.id} = ${client_latest_enrollment_per_agency.enrollment_id} ;;
  }

  join: client_first_enrollment_per_agency {
    relationship: one_to_one
    type: left_outer
    sql_on: ${enrollments.id} = ${client_first_enrollment_per_agency.enrollment_id} ;;
  }

  join: sys_1a1_final {
    type: left_outer
    relationship: many_to_one
    sql_on:  ${base.ref_client} = ${sys_1a1_final.personal_id};;
  }

  join: sys_1a2_final {
    relationship: many_to_one
    sql_on: ${base.ref_client} = ${sys_1a2_final.personal_id} ;;
  }

  join: sys_pm_1b1_final {
    type: left_outer
    relationship: many_to_one
    sql_on: ${base.ref_client} = ${sys_pm_1b1_final.personal_id} ;;
  }

  join: sys_pm_1b2_final {
    type: left_outer
    relationship: many_to_one
    sql_on: ${base.ref_client} = ${sys_pm_1b2_final.personal_id} ;;
  }

  join: clients_length_of_time_homeless {
    type: left_outer
    relationship: many_to_one
    sql_on: ${base.ref_client} = ${clients_length_of_time_homeless.personal_id} ;;
  }

  join: sys_pm_2_returns {
    type: left_outer
    relationship: many_to_one
    sql_on: ${sys_pm_2_ph_exits.enrollment_id} = ${sys_pm_2_returns.enrollment_id};;
  }

  join: sys_pm_2_ph_exits {
    type: inner
    relationship: many_to_one
    sql_on: ${enrollments.id} = ${sys_pm_2_ph_exits.enrollment_id};;
  }

  join: sys_pm_3 {
    type: left_outer
    relationship: many_to_many
    sql_on: ${clients.id} = ${sys_pm_3.personal_id} ;;
  }

  join: sys_pm_4_1_2_3 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_4_1_2_3.personal_id} ;;
  }

  join: sys_pm_4_4_5_6 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_4_4_5_6.personal_id} ;;
  }

  join: sys_pm_5_1_universe {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_5_1_universe.personal_id} ;;
  }

  join: sys_pm_5_1_c3 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_5_1_c3.personal_id} ;;
  }

  join: sys_pm_5_2_universe {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_5_2_universe.personal_id} ;;
  }

  join: sys_pm_5_2_c3 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_5_2_c3.personal_id} ;;
  }

  join: sys_pm_7a1_base {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_7a1_base.personal_id} ;;
  }

  join: sys_pm_7a1c2 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_7a1c2.personal_id} ;;
  }

  join: sys_pm_7a1c3 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_7a1c3.personal_id} ;;
  }

  join: sys_pm_7a1c4 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_7a1c4.personal_id} ;;
  }

  join: sys_pm_7b1c2 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_7b1c2.personal_id} ;;
  }

  join: sys_pm_7b1c3 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_7b1c3.personal_id} ;;
  }

  join: sys_pm_7b2c2 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_7b2c2.personal_id} ;;
  }

  join: sys_pm_7b2c3 {
    type: left_outer
    relationship: one_to_one
    sql_on: ${clients.id} = ${sys_pm_7b2c3.personal_id} ;;
  }

  join: hoh_client_location {
    type: left_outer
    relationship: many_to_many
    sql_on: ${enrollments.ref_household} = ${hoh_client_location.cp_ref_household} ;;
  }

  join: hoh_client_location_update {
    type: left_outer
    relationship: many_to_many
    sql_on: ${enrollments.ref_household} = ${hoh_client_location_update.cp_ref_household_update} ;;
  }

  join: base_latest_assessment {
    type: left_outer
    relationship: one_to_one
    sql_on: ${base_latest_assessment.assessment_id} = ${client_assessments.id};;
  }

  join: base_first_assessment {
    type: left_outer
    relationship: one_to_one
    sql_on: ${base_first_assessment.assessment_id} = ${client_assessments.id} ;;
  }

  join: base_latest_update_by_enrollment {
    type: left_outer
    relationship: one_to_one
    sql_on: ${base_latest_update_by_enrollment.enrollment_id} = ${enrollments.id}

             ;;
  }

  join: client_service_employment {
    relationship: one_to_one
    sql_on: ${client_service_employment.ref_client_service} = ${client_services.id} ;;
  }

  join: employers {
    fields: []
    relationship: many_to_one
    sql_on: ${client_service_employment.ref_employer} = ${employers.id} ;;

  }

  join: service_item_account_configuration {
    fields: [employment_placement]
    relationship: one_to_many
    sql_on: ${service_items.id} = ${service_item_account_configuration.ref_service_item} ;;
  }

  join: client_field_interactions_geolocations {
    fields: [client_field_interactions_geolocations*]
    relationship: one_to_one
    sql_on: ${client_field_interactions.ref_geolocation} = ${client_field_interactions_geolocations.id}
        AND ${client_field_interactions_geolocations.deleted} IS NULL
    ;;
  }

  join: client_addresses_geolocations {
    fields: [client_addresses_geolocations*]
    relationship: one_to_one
    sql_on: ${client_addresses.ref_geolocation} = ${client_addresses_geolocations.id}
        AND ${client_addresses_geolocations.deleted} IS NULL
    ;;
  }

  join: sites_geolocations {
    fields: [

             address,
             address2,
             city,
             state,
             zipcode
    ]
    relationship: one_to_one
    sql_on: ${sites.ref_geolocation} = ${sites_geolocations.id}
        AND ${sites_geolocations.deleted} IS NULL
    ;;
  }

#   join: client_geolocations {
#     relationship: one_to_one
#     sql_on: ${clients.ref_geolocation} = ${client_geolocations.id}
#             AND ${client_geolocations.deleted} IS NULL;;
#   }

#   join: client_services_geolocations {
#     relationship: one_to_one
#     sql_on:     ${client_services.ref_geolocation} = ${client_services_geolocations.id}
#             AND ${client_services_geolocations.deleted} IS NULL
#     ;;
#   }

#   join: service_items_geolocations {
#     relationship: one_to_one
#     sql_on:     ${service_items.ref_geolocation} = ${service_items_geolocations.id}
#             AND ${service_items_geolocations.deleted} IS NULL
#     ;;
#   }

#   join: client_assessment_demographics_geolocations {
#     relationship: one_to_one
#     sql_on:     ${client_assessments.ref_geolocation} = ${client_assessment_demographics_geolocations.id}
#             AND ${client_assessment_demographics_geolocations.deleted} IS NULL
#     ;;
#   }
#
#   join: client_program_demographics_geolocations {
#     relationship: one_to_one
#     sql_on:     ${screen_master.ref_geolocation} = ${client_program_demographics_geolocations.id}
#             AND ${client_program_demographics_geolocations.deleted} IS NULL
#     ;;
#   }

  # join: encampment_clients {
  #   relationship: one_to_many
  #   sql_on: ${base.ref_client} = ${encampment_clients.ref_client} ;;
  # }

  # join: encampments {
  #   relationship: one_to_one
  #   sql_on:  ${encampment_clients.ref_encampment} = ${encampments.id} ;;
  # }

  # join: encampments_normalized {
  #   relationship: one_to_many
  #   sql_on: ${encampments.id} = ${encampments_normalized.id} ;;
  # }



}
